int licenceLineIndex = 1;

for (ControllingLine existingCtrlLine : existingLicence.getControllingLines()) {
    incomingLicence.getControllingLines().stream()
        .filter(incomingCtrlLineItem -> incomingCtrlLineItem.getLineNumber().equals(existingCtrlLine.getLineNumber()))
        .findFirst()
        .ifPresent(incomingCtrlLine -> {
            if (incomingCtrlLine.getIssuedQuantity().getValue() != null) {
                BigDecimal incomingIssuedQty = incomingCtrlLine.getIssuedQuantity().getValue();
                double existingTotalReservedQty = RunningTotalsSummaryFunctions.calculateQuantityReserved(existingCtrlLine.getRunningTotals()).doubleValue();
                if (incomingIssuedQty.doubleValue() < existingTotalReservedQty) {
                    errors.add(LicenceUpdateError.builder()
                        .code(ERROR_CODE_24)
                        .message(ERROR_TEXT_24)
                        .path(String.format(CONTROL_LINE_PATH, licenceLineIndex))
                        .build());
                    log.error(String.format(
                        "Rejecting licence %s because the issued quantity %s for the controlling line record LicenceLine[%s] is below reserved quantity %s",
                        incomingLicence.getLicenceReference(), incomingIssuedQty, licenceLineIndex, existingTotalReservedQty));
                }
            }
        });
    licenceLineIndex++;
}
