@Component
@Order(Ordered.HIGHEST_PRECEDENCE) // Ensure it runs early
public class MdcCaptureTestFilter extends OncePerRequestFilter {

    public static final Map<String, String> MDC_VALUES = new ConcurrentHashMap<>();

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        try {
            filterChain.doFilter(request, response);
        } finally {
            MDC_VALUES.put("CONVERSATION", MDC.get("CONVERSATION_ID"));
            MDC_VALUES.put("REFERENCE", MDC.get("DECLARATION_ID"));
        }
    }
}